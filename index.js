// index.js
const express = require('express');
require('dotenv').config();
const { Client } = require('pg');
const cors = require('cors');
const fetch = require('node-fetch');

const app = express();
app.use(cors());
app.use(express.json());

const PORT = process.env.PORT || 3000;

// –¢–æ–∫–µ–Ω –¥–ª—è –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó Webhook –≤—ñ–¥ Meta
const VERIFY_TOKEN = process.env.VERIFY_TOKEN || 'director_verify';

// Instagram API —Ç–æ–∫–µ–Ω
const PAGE_ACCESS_TOKEN = process.env.PAGE_ACCESS_TOKEN;

// ID –≤–ª–∞—Å–Ω–æ–≥–æ Instagram –∞–∫–∫–∞—É–Ω—Ç—É (—â–æ–± –Ω–µ –∑–±–µ—Ä—ñ–≥–∞—Ç–∏ –π–æ–≥–æ —è–∫ –ª—ñ–¥–∞)
const OWN_INSTAGRAM_ID = process.env.OWN_INSTAGRAM_ID;

// –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —á–µ—Ä–µ–∑ Instagram API
async function sendInstagramMessage(recipientId, messageText) {
  if (!PAGE_ACCESS_TOKEN) {
    console.error('‚ùå PAGE_ACCESS_TOKEN –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
    throw new Error('PAGE_ACCESS_TOKEN –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
  }

  try {
    const response = await fetch('https://graph.facebook.com/v18.0/me/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${PAGE_ACCESS_TOKEN}`
      },
      body: JSON.stringify({
        recipient: {
          id: recipientId
        },
        message: {
          text: messageText
        }
      })
    });

    const result = await response.json();
    
    if (!response.ok) {
      console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è:', result);
      throw new Error(`Instagram API Error: ${result.error?.message || 'Unknown error'}`);
    }

    console.log('‚úÖ –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ —á–µ—Ä–µ–∑ Instagram API:', result);
    return result;
  } catch (error) {
    console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤—ñ–¥–ø—Ä–∞–≤—Ü—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è:', error);
    throw error;
  }
}

// –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö
const db = new Client({
  connectionString: process.env.DATABASE_URL || 'postgresql://postgres:postgres@localhost:5432/director',
});

db.connect()
  .then(() => console.log('‚úÖ Connected to DB'))
  .catch(err => console.error('‚ùå DB connection error', err));

// –í–∞–ª—ñ–¥–∞—Ü—ñ—è Webhook
app.get('/webhook', (req, res) => {
  const mode = req.query['hub.mode'];
  const token = req.query['hub.verify_token'];
  const challenge = req.query['hub.challenge'];

  if (mode === 'subscribe' && token === VERIFY_TOKEN) {
    console.log('‚úÖ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ Webhook!');
    res.status(200).send(challenge);
  } else {
    res.sendStatus(403);
  }
});

// –û–±—Ä–æ–±–∫–∞ –Ω–æ–≤–∏—Ö –ø–æ–¥—ñ–π –∑ Direct / Messenger
app.post('/webhook', async (req, res) => {
  try {
    const entry = req.body.entry?.[0];
    const msg = entry?.messaging?.[0];

    if (msg?.message && msg.sender?.id) {
      const igId = msg.sender.id;
      const text = msg.message.text || '';
      const ts = new Date(msg.timestamp);

      // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —Ü–µ –Ω–µ –Ω–∞—à –≤–ª–∞—Å–Ω–∏–π –∞–∫–∫–∞—É–Ω—Ç
      if (OWN_INSTAGRAM_ID && igId === OWN_INSTAGRAM_ID) {
        console.log('üîÑ –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥ –≤–ª–∞—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç—É:', igId);
        return res.sendStatus(200);
      }

      // 1) Upsert –ª—ñ–¥–∞ (—Ç—ñ–ª—å–∫–∏ —è–∫—â–æ —Ü–µ –Ω–µ –Ω–∞—à –∞–∫–∫–∞—É–Ω—Ç)
      // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —ñ—Å–Ω—É—é—Ç—å –Ω–æ–≤—ñ –∫–æ–ª–æ–Ω–∫–∏
      try {
        await db.query(
          `INSERT INTO leads (ig_id, first_seen, status)
           VALUES ($1, $2, 'NEW')
           ON CONFLICT (ig_id) DO NOTHING`,
          [igId, ts]
        );
      } catch (insertError) {
        // –Ø–∫—â–æ –ø–æ–º–∏–ª–∫–∞ —á–µ—Ä–µ–∑ –≤—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –∫–æ–ª–æ–Ω–∫–∏ status, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Å—Ç–∞—Ä—É —Å—Ö–µ–º—É
        if (insertError.code === '42703') { // column does not exist
          console.log('‚ö†Ô∏è –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Å—Ç–∞—Ä—É —Å—Ö–µ–º—É –ë–î –±–µ–∑ –∫–æ–ª–æ–Ω–∫–∏ status');
          await db.query(
            `INSERT INTO leads (ig_id, first_seen)
             VALUES ($1, $2)
             ON CONFLICT (ig_id) DO NOTHING`,
            [igId, ts]
          );
        } else {
          throw insertError;
        }
      }
      
      // 2) –ü—ñ–¥—Ç—è–≥–Ω—É—Ç–∏ username —ñ full_name —á–µ—Ä–µ–∑ Graph API
     const { rows: exist } = await db.query(
  `SELECT username FROM leads WHERE ig_id = $1`, [igId]
);
if (!exist[0].username) {
  const profile = await fetch(
    `https://graph.facebook.com/${igId}` +
    `?fields=username,name&access_token=${PAGE_ACCESS_TOKEN}`
  ).then(r => r.json());
  if (profile.username) {
    await db.query(`
      UPDATE leads
         SET username  = $1,
             full_name = $2
       WHERE ig_id = $3
    `, [profile.username, profile.name, igId]);
  }
}
      // 2) –û—Ç—Ä–∏–º–∞—Ç–∏ lead_id
      const { rows } = await db.query(
        `SELECT id FROM leads WHERE ig_id = $1`,
        [igId]
      );
      const leadId = rows[0].id;

      // 3) –ó–±–µ—Ä–µ–≥—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
      await db.query(
        `INSERT INTO messages (lead_id, text, timestamp, direction)
         VALUES ($1, $2, $3, 'inbound')`,
        [leadId, text, ts]
      );

      console.log('‚úî –ó–±–µ—Ä–µ–∂–µ–Ω–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥', igId);
    }
  } catch (e) {
    console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤ –ë–î', e);
  }
  res.sendStatus(200);
});

// ‚Ä¶ —É –≤–∞—à–æ–º—É index.js, –ø—ñ—Å–ª—è app.post('/webhook') ‚Ä¶

// 1) –ü–æ–≤–µ—Ä–Ω—É—Ç–∏ –≤–µ—Å—å —Å–ø–∏—Å–æ–∫ –ª—ñ–¥—ñ–≤
app.get('/leads', async (req, res) => {
  try {
    const { status } = req.query;
    
    // –°–ø–æ—á–∞—Ç–∫—É –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —ñ—Å–Ω—É—î –∫–æ–ª–æ–Ω–∫–∞ is_own_account
    let query = `
      SELECT id, ig_id, username, full_name, first_seen, status
      FROM leads
    `;
    
    // –î–æ–¥–∞—î–º–æ —É–º–æ–≤—É –¥–ª—è is_own_account —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ –∫–æ–ª–æ–Ω–∫–∞ —ñ—Å–Ω—É—î
    try {
      await db.query(`SELECT is_own_account FROM leads LIMIT 1`);
      query += ` WHERE (is_own_account IS FALSE OR is_own_account IS NULL)`;
    } catch (columnError) {
      console.log('‚ö†Ô∏è –ö–æ–ª–æ–Ω–∫–∞ is_own_account –Ω–µ —ñ—Å–Ω—É—î, –ø—Ä–æ–ø—É—Å–∫–∞—î–º–æ —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—é');
      // –ö–æ–ª–æ–Ω–∫–∞ –Ω–µ —ñ—Å–Ω—É—î, –ø—Ä–æ–¥–æ–≤–∂—É—î–º–æ –±–µ–∑ —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—ó
    }
    
    const params = [];
    
    // –§—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è –∑–∞ —Å—Ç–∞—Ç—É—Å–æ–º —è–∫—â–æ –ø–µ—Ä–µ–¥–∞–Ω–æ
    if (status && status !== 'all') {
      const hasWhere = query.includes('WHERE');
      query += hasWhere ? ` AND status = $1` : ` WHERE status = $1`;
      params.push(status);
    }
    
    query += ` ORDER BY first_seen DESC`;
    
    console.log('üîç Executing query:', query, 'with params:', params);
    const { rows } = await db.query(query, params);
    console.log('‚úÖ Found', rows.length, 'leads');
    res.json(rows);
  } catch (e) {
    console.error('‚ùå Error in GET /leads:', e.message);
    console.error('Full error:', e);
    res.status(500).json({ 
      error: 'Server error', 
      message: e.message,
      code: e.code 
    });
  }
});

// 2) –ü–æ–≤–µ—Ä–Ω—É—Ç–∏ —á–∞—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ª—ñ–¥–∞
app.get('/leads/:id', async (req, res) => {
  try {
    const { id } = req.params;
    
    // –û—Ç—Ä–∏–º—É—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –ª—ñ–¥–∞
    const leadResult = await db.query(
      'SELECT * FROM leads WHERE id = $1',
      [id]
    );

    if (leadResult.rows.length === 0) {
      return res.status(404).json({ error: 'Lead not found' });
    }

    // –û—Ç—Ä–∏–º—É—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ª—ñ–¥–∞
    const messagesResult = await db.query(
      'SELECT * FROM messages WHERE lead_id = $1 ORDER BY timestamp ASC',
      [id]
    );

    res.json({
      lead: leadResult.rows[0],
      messages: messagesResult.rows
    });
  } catch (error) {
    console.error('Error getting lead:', error);
    res.status(500).json({ error: 'Internal server error' });
  }
});

// API –¥–ª—è —à–∞–±–ª–æ–Ω—ñ–≤ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
app.get('/templates', async (req, res) => {
  try {
    const result = await db.query(
      'SELECT * FROM message_templates ORDER BY category, name'
    );
    res.json(result.rows);
  } catch (error) {
    console.error('Error getting templates:', error);
    res.status(500).json({ error: 'Internal server error' });
  }
});

app.post('/templates', async (req, res) => {
  const { name, content, category } = req.body;
  try {
    const { rows } = await db.query(
      `INSERT INTO message_templates (name, content, category)
       VALUES ($1, $2, $3)
       RETURNING *`,
      [name, content, category]
    );
    res.json(rows[0]);
  } catch (e) {
    console.error('Error in POST /templates', e);
    res.status(500).send('Server error');
  }
});

app.put('/templates/:id', async (req, res) => {
  const { id } = req.params;
  const { name, content, category } = req.body;
  try {
    const { rows } = await db.query(
      `UPDATE message_templates
       SET name = $1, content = $2, category = $3
       WHERE id = $4
       RETURNING *`,
      [name, content, category, id]
    );
    res.json(rows[0]);
  } catch (e) {
    console.error('Error in PUT /templates/:id', e);
    res.status(500).send('Server error');
  }
});

app.delete('/templates/:id', async (req, res) => {
  const { id } = req.params;
  try {
    await db.query('DELETE FROM message_templates WHERE id = $1', [id]);
    res.sendStatus(200);
  } catch (e) {
    console.error('Error in DELETE /templates/:id', e);
    res.status(500).send('Server error');
  }
});

// –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å —á–µ—Ä–µ–∑ Instagram API
app.post('/messages', async (req, res) => {
  try {
    const { lead_id, text, direction } = req.body;

    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —ñ—Å–Ω—É—î –ª—ñ–¥
    const leadExists = await db.query(
      'SELECT id FROM leads WHERE id = $1',
      [lead_id]
    );

    if (leadExists.rows.length === 0) {
      return res.status(404).json({ error: 'Lead not found' });
    }

    // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
    const result = await db.query(
      `INSERT INTO messages (lead_id, text, direction, timestamp)
       VALUES ($1, $2, $3, CURRENT_TIMESTAMP)
       RETURNING *`,
      [lead_id, text, direction]
    );

    res.status(201).json(result.rows[0]);
  } catch (error) {
    console.error('Error creating message:', error);
    res.status(500).json({ error: 'Internal server error' });
  }
});

// –û—Ç—Ä–∏–º–∞–Ω–Ω—è —Å–ø–∏—Å–∫—É —Å—Ç–∞—Ç—É—Å—ñ–≤ –ª—ñ–¥—ñ–≤
app.get('/lead-statuses', (req, res) => {
  const statuses = [
    { value: 'NEW', label: '–ù–æ–≤–∏–π', color: 'blue' },
    { value: 'CONTACTED', label: '–ö–æ–Ω—Ç–∞–∫—Ç –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', color: 'yellow' },
    { value: 'QUALIFIED', label: '–ö–≤–∞–ª—ñ—Ñ—ñ–∫–æ–≤–∞–Ω–∏–π', color: 'purple' },
    { value: 'PROPOSAL', label: '–ü—Ä–æ–ø–æ–∑–∏—Ü—ñ—è –Ω–∞–¥—ñ—Å–ª–∞–Ω–∞', color: 'orange' },
    { value: 'NEGOTIATION', label: '–ü–µ—Ä–µ–≥–æ–≤–æ—Ä–∏', color: 'indigo' },
    { value: 'CLOSED_WON', label: '–£—Å–ø—ñ—à–Ω–æ –∑–∞–∫—Ä–∏—Ç–æ', color: 'green' },
    { value: 'CLOSED_LOST', label: '–í—Ç—Ä–∞—á–µ–Ω–æ', color: 'red' },
    { value: 'ON_HOLD', label: '–ù–∞ –ø–∞—É–∑—ñ', color: 'gray' },
    { value: 'FOLLOW_UP', label: '–ü–æ–≤—Ç–æ—Ä–Ω–∏–π –∫–æ–Ω—Ç–∞–∫—Ç', color: 'pink' }
  ];
  
  res.json(statuses);
});

// –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É –ª—ñ–¥–∞
app.patch('/leads/:id', async (req, res) => {
  try {
    const { id } = req.params;
    const { status } = req.body;

    // –í–∞–ª—ñ–¥–∞—Ü—ñ—è —Å—Ç–∞—Ç—É—Å—É
    const validStatuses = [
      'NEW', 'CONTACTED', 'QUALIFIED', 'PROPOSAL', 'NEGOTIATION',
      'CLOSED_WON', 'CLOSED_LOST', 'ON_HOLD', 'FOLLOW_UP'
    ];
    
    if (!validStatuses.includes(status)) {
      return res.status(400).json({ error: 'Invalid status' });
    }

    const result = await db.query(
      'UPDATE leads SET status = $1, updated_at = CURRENT_TIMESTAMP WHERE id = $2 RETURNING *',
      [status, id]
    );

    if (result.rows.length === 0) {
      return res.status(404).json({ error: 'Lead not found' });
    }

    res.json(result.rows[0]);
  } catch (error) {
    console.error('Error updating lead:', error);
    res.status(500).json({ error: 'Internal server error' });
  }
});

// –û—Ç—Ä–∏–º–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —á–∞—Ç—É
app.get('/chats/:id', async (req, res) => {
  try {
    const { id } = req.params;
    
    // –û—Ç—Ä–∏–º—É—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ª—ñ–¥–∞
    const messagesResult = await db.query(
      `SELECT 
        m.id,
        m.text as content,
        m.timestamp,
        CASE 
          WHEN m.direction = 'outbound' THEN true 
          ELSE false 
        END as is_own
      FROM messages m
      WHERE m.lead_id = $1 
      ORDER BY m.timestamp ASC`,
      [id]
    );

    res.json({
      messages: messagesResult.rows
    });
  } catch (error) {
    console.error('Error getting chat messages:', error);
    res.status(500).json({ error: 'Internal server error' });
  }
});

// –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ —á–∞—Ç
app.post('/chats/:id/send', async (req, res) => {
  try {
    const { id } = req.params;
    const { message, type = 'text' } = req.body;

    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —ñ—Å–Ω—É—î –ª—ñ–¥
    const leadExists = await db.query(
      'SELECT id, ig_id FROM leads WHERE id = $1',
      [id]
    );

    if (leadExists.rows.length === 0) {
      return res.status(404).json({ error: 'Lead not found' });
    }

    const lead = leadExists.rows[0];
    const igId = lead.ig_id;

    // –°–ø—Ä–æ–±—É—î–º–æ –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —á–µ—Ä–µ–∑ Instagram API
    let instagramResult = null;
    let sendError = null;

    try {
      instagramResult = await sendInstagramMessage(igId, message);
      console.log('‚úÖ –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —É—Å–ø—ñ—à–Ω–æ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ —á–µ—Ä–µ–∑ Instagram API');
    } catch (error) {
      sendError = error;
      console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ —á–µ—Ä–µ–∑ Instagram API:', error.message);
    }

    // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ –ë–î –Ω–µ–∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É –≤—ñ–¥–ø—Ä–∞–≤–∫–∏
    const result = await db.query(
      `INSERT INTO messages (lead_id, text, direction, timestamp)
       VALUES ($1, $2, 'outbound', CURRENT_TIMESTAMP)
       RETURNING 
         id,
         text as content,
         timestamp,
         true as is_own`,
      [id, message]
    );

    // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—î—é –ø—Ä–æ —Å—Ç–∞—Ç—É—Å –≤—ñ–¥–ø—Ä–∞–≤–∫–∏
    const response = {
      ...result.rows[0],
      instagram_sent: !!instagramResult,
      instagram_error: sendError ? sendError.message : null
    };

    res.status(201).json(response);
  } catch (error) {
    console.error('Error sending message:', error);
    res.status(500).json({ error: 'Internal server error' });
  }
});

// Endpoint –¥–ª—è –∑–∞–ø—É—Å–∫—É –º—ñ–≥—Ä–∞—Ü—ñ–π
app.post('/admin/migrate', async (req, res) => {
  try {
    console.log('üîÑ –ó–∞–ø—É—Å–∫ –º—ñ–≥—Ä–∞—Ü—ñ–π...');
    
    // –ú—ñ–≥—Ä–∞—Ü—ñ—è 1: –î–æ–¥–∞–≤–∞–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—ñ–≤ —Ç–∞ is_own_account
    try {
      await db.query(`
        ALTER TABLE leads ADD COLUMN IF NOT EXISTS status VARCHAR(50) DEFAULT 'NEW';
      `);
      console.log('‚úÖ –î–æ–¥–∞–Ω–æ –∫–æ–ª–æ–Ω–∫—É status');
    } catch (e) {
      console.log('‚ö†Ô∏è –ö–æ–ª–æ–Ω–∫–∞ status –≤–∂–µ —ñ—Å–Ω—É—î –∞–±–æ –ø–æ–º–∏–ª–∫–∞:', e.message);
    }

    try {
      await db.query(`
        ALTER TABLE leads ADD COLUMN IF NOT EXISTS is_own_account BOOLEAN DEFAULT FALSE;
      `);
      console.log('‚úÖ –î–æ–¥–∞–Ω–æ –∫–æ–ª–æ–Ω–∫—É is_own_account');
    } catch (e) {
      console.log('‚ö†Ô∏è –ö–æ–ª–æ–Ω–∫–∞ is_own_account –≤–∂–µ —ñ—Å–Ω—É—î –∞–±–æ –ø–æ–º–∏–ª–∫–∞:', e.message);
    }

    // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —ñ—Å–Ω—É—é—á–∏—Ö –∑–∞–ø–∏—Å—ñ–≤
    try {
      await db.query(`
        UPDATE leads SET status = 'NEW' WHERE status IS NULL OR status = '';
      `);
      console.log('‚úÖ –û–Ω–æ–≤–ª–µ–Ω–æ —Å—Ç–∞—Ç—É—Å–∏ —ñ—Å–Ω—É—é—á–∏—Ö –ª—ñ–¥—ñ–≤');
    } catch (e) {
      console.log('‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—ñ–≤:', e.message);
    }

    // –î–æ–¥–∞–≤–∞–Ω–Ω—è constraint (–º–æ–∂–µ –Ω–µ —Å–ø—Ä–∞—Ü—é–≤–∞—Ç–∏ —è–∫—â–æ –≤–∂–µ —ñ—Å–Ω—É—î)
    try {
      await db.query(`
        ALTER TABLE leads 
        ADD CONSTRAINT leads_status_check 
        CHECK (status IN (
          'NEW', 'CONTACTED', 'QUALIFIED', 'PROPOSAL', 'NEGOTIATION',
          'CLOSED_WON', 'CLOSED_LOST', 'ON_HOLD', 'FOLLOW_UP'
        ));
      `);
      console.log('‚úÖ –î–æ–¥–∞–Ω–æ constraint –¥–ª—è —Å—Ç–∞—Ç—É—Å—ñ–≤');
    } catch (e) {
      console.log('‚ö†Ô∏è Constraint –≤–∂–µ —ñ—Å–Ω—É—î –∞–±–æ –ø–æ–º–∏–ª–∫–∞:', e.message);
    }

    // –î–æ–¥–∞–≤–∞–Ω–Ω—è —ñ–Ω–¥–µ–∫—Å—ñ–≤
    try {
      await db.query(`CREATE INDEX IF NOT EXISTS idx_leads_status ON leads(status);`);
      await db.query(`CREATE INDEX IF NOT EXISTS idx_leads_is_own_account ON leads(is_own_account);`);
      console.log('‚úÖ –î–æ–¥–∞–Ω–æ —ñ–Ω–¥–µ–∫—Å–∏');
    } catch (e) {
      console.log('‚ö†Ô∏è –Ü–Ω–¥–µ–∫—Å–∏ –≤–∂–µ —ñ—Å–Ω—É—é—Ç—å –∞–±–æ –ø–æ–º–∏–ª–∫–∞:', e.message);
    }

    console.log('üéâ –ú—ñ–≥—Ä–∞—Ü—ñ—ó –∑–∞–≤–µ—Ä—à–µ–Ω–æ!');
    res.json({ 
      success: true, 
      message: '–ú—ñ–≥—Ä–∞—Ü—ñ—ó —É—Å–ø—ñ—à–Ω–æ –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ' 
    });
  } catch (error) {
    console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –º—ñ–≥—Ä–∞—Ü—ñ—ó:', error);
    res.status(500).json({ 
      success: false, 
      error: error.message 
    });
  }
});

// –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
app.listen(PORT, () => {
  console.log(`üöÄ Server running on port ${PORT}`);
});


